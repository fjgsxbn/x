name: Generate Android P12 Signing Key

on:
  workflow_dispatch:  # 手动触发工作流（点击 GitHub 仓库的 Actions 标签运行）

jobs:
  generate-p12:
    runs-on: ubuntu-latest
    steps:
      - name: 拉取代码库
        uses: actions/checkout@v4

      - name: 安装 Java（依赖 keytool）
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: 生成 P12 格式签名证书
        run: |
          # 创建存放证书的目录（如 keystore）
          mkdir -p keystore
          
          # 生成 PKCS12 格式证书（.p12）
          keytool -genkeypair \
            -alias 'app-alias' \  # 证书别名（需与 build.gradle 中 keyAlias 一致）
            -keyalg RSA \            # 加密算法
            -keysize 2048 \          # 密钥长度
            -validity 3650 \         # 有效期（10年）
            -storetype PKCS12 \      # 指定格式为 PKCS12
            -keystore keystore/release.p12 \  # 输出路径和文件名
            -storepass "$STORE_PASSWORD \  # 密钥库密码（-storepass）
            -keypass "$KEY_PASSWORD" \      # 密钥密码（-keypass）
            -dname "CN=MyApp, OU=Dev, O=MyOrg, L=Beijing, ST=Beijing, C=CN"  # 证书信息
        env:
          # 从 GitHub Secrets 读取密码（需提前配置）
          STORE_PASSWORD: ${{ secrets.CERT_STORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.CERT_KEY_PASSWORD }}

      - name: 提交证书到版本库
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          git add keystore/release.p12  # 添加生成的证书
          git commit -m "Add generated P12 signing key"  # 提交信息
          git push origin main  # 推送到主分支（根据实际分支名修改）
