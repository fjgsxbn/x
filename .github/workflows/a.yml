name: Generate Cert (Public Repo) and Save to Secrets

on:
  workflow_dispatch:  # 仅手动触发，避免自动运行

jobs:
  generate-cert:
    runs-on: ubuntu-latest
    environment: production  # 建议启用环境审查（需在仓库设置中配置）
    steps:
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Generate certificate and encode to Base64
        id: generate
        run: |
          # 生成PKCS12格式证书
          KEYSTORE_NAME="secure-cert.p12"
          keytool -genkeypair \
            -keystore $KEYSTORE_NAME \
            -storetype PKCS12 \
            -storepass "$STORE_PASSWORD" \
            -alias "app-alias" \
            -keypass "$KEY_PASSWORD" \
            -keyalg RSA \
            -keysize 2048 \
            -validity 3650 \
            -dname "CN=PublicApp, OU=Dev, O=Open, L=City, ST=Region, C=XX" \
            -noprompt

          # 转换为Base64并输出为步骤变量（不打印具体内容）
          BASE64_CERT=$(base64 -w 0 $KEYSTORE_NAME)
          echo "base64_cert=$BASE64_CERT" >> $GITHUB_OUTPUT
        env:
          # 从Secrets读取密码（提前创建这两个Secret）
          STORE_PASSWORD: ${{ secrets.CERT_KEYSTORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.CERT_KEY_PASSWORD }}

      - name: 提交证书到版本库
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          git add keystore/release.p12  # 添加生成的证书
          git commit -m "Add generated P12 signing key"  # 提交信息
          git push origin main  # 推送到主分支（根据实际分支名修改）
